var spawner={roleMoves:{harvester:[WORK,CARRY,MOVE],builder:[WORK,CARRY,MOVE],upgrader:[WORK,CARRY,MOVE],repairer:[WORK,CARRY,MOVE]},spawn:function(e){console.log("Spawning new: "+e);var r=this.roleMoves[e];Game.spawns.Spawn1.createCreep(r,{role:e})},controlPopulation:function(){if(0===Game.time%30){console.log("Controlling population..");for(var e in Memory.creeps)Game.creeps[e]||delete Memory.creeps[e];var r={harvester:0,builder:0,upgrader:0,repairer:0},o={harvester:3,builder:3,upgrader:1,repairer:3};for(var t in Game.creeps){var a=Game.creeps[t];r[a.memory.role]=r[a.memory.role]+1}for(var n in r)console.log("Role ["+n+"] count: "+r[n]),r[n]<o[n]&&this.spawn(n)}}},roleHarvester={run:function(e){if(e.carry.energy<e.carryCapacity){var r=e.pos.findClosestByRange(FIND_SOURCES);e.harvest(r)==ERR_NOT_IN_RANGE&&e.moveTo(r)}else{var o;if(e.memory.targetId||(o=this.findTarget(e)),e.memory.targetId){o||(o=Game.getObjectById(e.memory.targetId));var t=e.transfer(o,RESOURCE_ENERGY);t==ERR_NOT_IN_RANGE?e.moveTo(o):t==ERR_FULL?this.findTarget(e):t!=OK&&console.log(e.name+" is stuck: "+t)}else e.upgradeController(e.room.controller)==ERR_NOT_IN_RANGE&&e.moveTo(e.room.controller)}},findTarget:function(e){e.memory.targetId=void 0;var r=e.pos.findClosestByRange(FIND_STRUCTURES,{filter:function(e){return(e.structureType==STRUCTURE_EXTENSION||e.structureType==STRUCTURE_SPAWN||e.structureType==STRUCTURE_TOWER)&&e.energy<e.energyCapacity}});r?e.memory.targetId=r.id:(r=e.pos.findClosestByRange(FIND_STRUCTURES,{filter:function(e){return e.structureType==STRUCTURE_CONTAINER&&e.store&&e.store.energy<e.storeCapacity}}),r&&(e.memory.targetId=r.id))}},roleRepairer={run:function(e){if(e.memory.temprole&&"harvester"==e.memory.temprole&&0!==Game.time%50)roleHarvester.run(e);else if(e.memory.temprole=void 0,e.memory.repairing&&0===e.carry.energy&&(e.memory.repairing=!1),e.memory.repairing||e.carry.energy!=e.carryCapacity||(this.findTarget(e),e.memory.repairing=!0),e.memory.repairing){var r;e.memory.targetId||this.findTarget(e),e.memory.targetId&&(r=Game.getObjectById(e.memory.targetId),r.hits>r.hitsMax/2&&(this.findTarget(e),r=Game.getObjectById(e.memory.targetId)),e.repair(r)==ERR_NOT_IN_RANGE&&e.moveTo(r))}else{var o=e.pos.findClosestByRange(FIND_SOURCES);e.harvest(o)==ERR_NOT_IN_RANGE&&e.moveTo(o)}},findTarget:function(e){var r=e.pos.findClosestByRange(FIND_STRUCTURES,{filter:function(e){return e.hits<e.hitsMax/2}});r?e.memory.targetId=r.id:(console.log(e.name+" temping as harvester"),e.memory.temprole="harvester")}},roleUpgrader={run:function(e){if(0===e.carry.energy){var r=e.pos.findClosestByRange(FIND_SOURCES);e.harvest(r)==ERR_NOT_IN_RANGE&&e.moveTo(r)}else e.upgradeController(e.room.controller)==ERR_NOT_IN_RANGE&&e.moveTo(e.room.controller)}},roleBuilder={run:function(e){if(e.memory.building&&0===e.carry.energy&&(e.memory.building=!1),e.memory.building||e.carry.energy!=e.carryCapacity||(e.memory.building=!0,this.findTarget(e)),e.memory.building){if(e.memory.targetId||this.findTarget(e),e.memory.targetId){var r=Game.getObjectById(e.memory.targetId),o=e.build(r);o==ERR_NOT_IN_RANGE?e.moveTo(r):o!=OK&&console.log(e.name+" builder stuck: "+o)}}else{var t=e.pos.findClosestByRange(FIND_SOURCES);e.harvest(t)==ERR_NOT_IN_RANGE&&e.moveTo(t)}},findTarget:function(e){e.memory.targetId=void 0;var r=e.pos.findClosestByRange(FIND_CONSTRUCTION_SITES);r&&(e.memory.targetId=r.id)}};module.exports.loop=function(){spawner.controlPopulation();for(var e in Game.creeps){var r=Game.creeps[e];"harvester"==r.memory.role?roleHarvester.run(r):"upgrader"==r.memory.role?roleUpgrader.run(r):"builder"==r.memory.role?roleBuilder.run(r):"repairer"==r.memory.role&&roleRepairer.run(r)}};